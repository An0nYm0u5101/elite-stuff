#!/usr/bin/env python
# -*- coding:utf-8 -*-
#
# Usage:
#   msf-local-exploits-suggester <session-id>
#

from os import sys, path
import time
import re
sys.path.append(path.dirname(path.dirname(path.abspath(__file__))))

import rpcutils
client = rpcutils.login()

if len(sys.argv) < 2:
    print 'Which session?!'
    exit(1)

cmds = []
cid = client.call("console.create", [{}])["id"]
client.call("console.read", [cid])

cmds.append("use multi/recon/local_exploit_suggester")
cmds.append("set SESSION %s" % sys.argv[1])
cmds.append("run")
cmds.append("")

client.call("console.write", [cid, "\r\n".join(cmds)])
while True:
    time.sleep(5)
    r = client.call("console.read", [cid])
    if r.get("data"):
        for line in r.get("data").split("\n"):
            if line.startswith("[+]"):
                print re.search(" - (.*):", line).group(1)
    if not r.get("busy"):
        break

client.call("console.destroy", [cid])
