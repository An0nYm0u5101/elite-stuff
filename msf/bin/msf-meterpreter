#!/usr/bin/env python
# -*- coding:utf-8 -*-
from os import sys, path
sys.path.append(path.dirname(path.dirname(path.abspath(__file__))))

import rpcutils
import time

class MsfMeterpreter(rpcutils.MsfCmd):
    def __init__(self, sid):
        rpcutils.MsfCmd.__init__(self)

        self.sid = sid
        self.prompt = "#%s meterpreter> " % self.sid

    def read_data(self):
        return self.client.call("session.meterpreter_read", [self.sid])

    def onecmd(self, cmd):
        self.wait_lock()
        self.lock()

        if cmd in ["exit", "EOF"]: self.do_exit(cmd); return True
        self.client.call("session.meterpreter_write", [self.sid, "%s\r\n" % cmd])
        time.sleep(1)
        print self.read_data().get("data")
        self.unlock()

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print "Which meterpreter session?"
        exit(1)
    if len(sys.argv) == 3:
        MsfMeterpreter(sys.argv[1]).onecmd(sys.argv[2])
    else:
        MsfMeterpreter(sys.argv[1]).cmdloop()
